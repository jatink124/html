<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trading Journal Analyzer</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for JSX support in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <!-- IMPORTANT: type="text/babel" so JSX works -->
  <script type="text/babel">
    const { useState, useMemo } = React;

    // Helpers
    const parseHour = (ts) => {
      if (!ts) return null;
      const parts = ts.split(":");
      const h = parseInt(parts[0], 10);
      return Number.isNaN(h) ? null : h;
    };

    const groupBy = (items, keyFn) => {
      const map = new Map();
      for (const item of items) {
        const key = keyFn(item);
        if (key == null) continue;
        map.set(key, (map.get(key) || 0) + 1);
      }
      return map;
    };

    function StatCard({ label, value, sub }) {
      return (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl px-4 py-3 flex flex-col gap-1">
          <span className="text-xs uppercase tracking-wide text-slate-400">
            {label}
          </span>
          <span className="text-xl font-semibold text-slate-50">
            {value}
          </span>
          {sub && (
            <span className="text-xs text-slate-500">
              {sub}
            </span>
          )}
        </div>
      );
    }

    function AreaDistribution({ data }) {
      const areaCounts = useMemo(() => groupBy(data, d => d.area || "Unknown"), [data]);
      const entries = Array.from(areaCounts.entries()).sort((a, b) => b[1] - a[1]);
      const total = data.length || 1;
      const max = entries.length ? entries[0][1] : 1;

      if (!entries.length) return (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 text-xs text-slate-500">
          Import JSON to see area distribution.
        </div>
      );

      return (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 flex flex-col gap-3">
          <div className="flex justify-between items-center">
            <h2 className="text-sm font-semibold text-slate-100">Area Distribution</h2>
            <span className="text-xs text-slate-500">By count</span>
          </div>
          <div className="space-y-2 max-h-56 overflow-y-auto pr-1">
            {entries.map(([area, count]) => {
              const pct = ((count / total) * 100).toFixed(0);
              const intensity = 20 + Math.round((count / max) * 60);
              return (
                <div key={area} className="flex items-center gap-2">
                  <div className="flex-1">
                    <div className="flex justify-between text-xs mb-1">
                      <span className="truncate text-slate-200">{area}</span>
                      <span className="text-slate-400">{count} ({pct}%)</span>
                    </div>
                    <div className="w-full h-2 rounded-full bg-slate-800 overflow-hidden">
                      <div
                        className="h-full bg-emerald-400"
                        style={{ width: `${pct}%`, opacity: intensity / 100 }}
                      />
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function HourHeatmap({ data }) {
      const hourCounts = useMemo(
        () => groupBy(data, d => parseHour(d.timestamp)),
        [data]
      );
      const max = Math.max(...Array.from(hourCounts.values()), 0);

      return (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 flex flex-col gap-3">
          <div className="flex justify-between items-center">
            <h2 className="text-sm font-semibold text-slate-100">Activity by Hour</h2>
            <span className="text-xs text-slate-500">0–23 (based on timestamp)</span>
          </div>
          <div className="grid grid-cols-12 gap-1 text-[10px]">
            {Array.from({ length: 12 }).map((_, row) => {
              const base = row * 2;
              return [base, base + 1].map((hour) => {
                if (hour > 23) return null;
                const count = hourCounts.get(hour) || 0;
                const ratio = max ? count / max : 0;
                const bg =
                  ratio === 0
                    ? "bg-slate-800"
                    : ratio < 0.33
                    ? "bg-emerald-900"
                    : ratio < 0.66
                    ? "bg-emerald-600"
                    : "bg-emerald-400";
                return (
                  <div
                    key={hour}
                    className={`flex flex-col items-center justify-between rounded-md px-1 py-1 ${bg} transition-colors`}
                  >
                    <span className="font-mono">{hour.toString().padStart(2, "0")}</span>
                    <span className="text-[9px] text-slate-100">{count}</span>
                  </div>
                );
              });
            })}
          </div>
        </div>
      );
    }

    function ImageModal({ entry, onClose }) {
      if (!entry) return null;
      return (
        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
          <div className="bg-slate-900 rounded-2xl shadow-2xl max-w-5xl w-[90vw] max-h-[90vh] flex flex-col overflow-hidden">
            <div className="px-4 py-3 border-b border-slate-800 flex justify-between items-center">
              <div>
                <h3 className="text-sm font-semibold">{entry.area || "No area"}</h3>
                <p className="text-xs text-slate-400">
                  {entry.timestamp} • {entry.id}
                </p>
              </div>
              <button
                onClick={onClose}
                className="text-xs px-3 py-1 rounded-full bg-slate-800 hover:bg-slate-700"
              >
                Close
              </button>
            </div>
            <div className="flex-1 overflow-auto bg-slate-950 flex">
              {entry.image ? (
                <img
                  src={entry.image}
                  alt={entry.notes || ""}
                  className="max-h-[80vh] mx-auto object-contain"
                />
              ) : (
                <div className="flex-1 flex items-center justify-center text-slate-500 text-sm">
                  No image available
                </div>
              )}
            </div>
            {entry.notes && (
              <div className="px-4 py-3 border-t border-slate-800 text-sm text-slate-200">
                <span className="font-semibold text-slate-300">Notes: </span>
                {entry.notes}
              </div>
            )}
          </div>
        </div>
      );
    }

    function JournalTable({ data, onOpenImage }) {
      const [sortKey, setSortKey] = useState("timestamp");
      const [sortDir, setSortDir] = useState("desc");

      const sorted = useMemo(() => {
        const copy = [...data];
        copy.sort((a, b) => {
          let av = a[sortKey];
          let bv = b[sortKey];
          if (sortKey === "timestamp") {
            const ah = parseHour(a.timestamp) ?? -1;
            const bh = parseHour(b.timestamp) ?? -1;
            if (ah === bh) return 0;
            return sortDir === "asc" ? ah - bh : bh - ah;
          }
          if (typeof av === "string") av = av.toLowerCase();
          if (typeof bv === "string") bv = bv.toLowerCase();
          if (av < bv) return sortDir === "asc" ? -1 : 1;
          if (av > bv) return sortDir === "asc" ? 1 : -1;
          return 0;
        });
        return copy;
      }, [data, sortKey, sortDir]);

      const toggleSort = (key) => {
        if (key === sortKey) {
          setSortDir((d) => (d === "asc" ? "desc" : "asc"));
        } else {
          setSortKey(key);
          setSortDir("asc");
        }
      };

      const SortIcon = ({ col }) => {
        if (col !== sortKey) {
          return <span className="text-slate-600 text-xs ml-1">↕</span>;
        }
        return (
          <span className="text-emerald-400 text-xs ml-1">
            {sortDir === "asc" ? "↑" : "↓"}
          </span>
        );
      };

      return (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl overflow-hidden flex flex-col h-full">
          <div className="px-4 py-3 border-b border-slate-800 flex justify-between items-center">
            <h2 className="text-sm font-semibold text-slate-100">
              Journal Entries ({data.length})
            </h2>
          </div>
          <div className="overflow-auto flex-1">
            <table className="min-w-full text-xs">
              <thead className="bg-slate-900/80 sticky top-0 z-10">
                <tr>
                  <th
                    className="text-left px-3 py-2 font-medium text-slate-400 cursor-pointer whitespace-nowrap"
                    onClick={() => toggleSort("timestamp")}
                  >
                    Time
                    <SortIcon col="timestamp" />
                  </th>
                  <th
                    className="text-left px-3 py-2 font-medium text-slate-400 cursor-pointer whitespace-nowrap"
                    onClick={() => toggleSort("area")}
                  >
                    Area
                    <SortIcon col="area" />
                  </th>
                  <th className="text-left px-3 py-2 font-medium text-slate-400">
                    Notes
                  </th>
                  <th className="text-left px-3 py-2 font-medium text-slate-400">
                    Img
                  </th>
                  <th className="text-left px-3 py-2 font-medium text-slate-400 whitespace-nowrap">
                    ID
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-800">
                {sorted.map((entry) => (
                  <tr
                    key={entry.id}
                    className="hover:bg-slate-800/60 transition-colors"
                  >
                    <td className="px-3 py-2 font-mono text-[11px] text-slate-200">
                      {entry.timestamp}
                    </td>
                    <td className="px-3 py-2 text-[11px] text-emerald-300 whitespace-nowrap max-w-[160px] truncate">
                      {entry.area || <span className="text-slate-500">–</span>}
                    </td>
                    <td className="px-3 py-2 text-[11px] text-slate-200 max-w-[260px]">
                      <div className="line-clamp-2">
                        {entry.notes || <span className="text-slate-500">No notes</span>}
                      </div>
                    </td>
                    <td className="px-3 py-2">
                      {entry.image ? (
                        <button
                          onClick={() => onOpenImage(entry)}
                          className="text-[10px] px-2 py-1 rounded-full bg-slate-800 hover:bg-slate-700 text-emerald-300"
                        >
                          View
                        </button>
                      ) : (
                        <span className="text-[10px] text-slate-500">–</span>
                      )}
                    </td>
                    <td className="px-3 py-2 text-[10px] text-slate-500 font-mono">
                      {entry.id}
                    </td>
                  </tr>
                ))}
                {sorted.length === 0 && (
                  <tr>
                    <td
                      colSpan={5}
                      className="px-4 py-8 text-center text-sm text-slate-500"
                    >
                      {data.length === 0
                        ? "Import a JSON file to see entries."
                        : "No entries match the filters."}
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function App() {
      const [rawData, setRawData] = useState([]);
      const [loadError, setLoadError] = useState("");
      const [search, setSearch] = useState("");
      const [selectedArea, setSelectedArea] = useState("All");
      const [hourRange, setHourRange] = useState([0, 23]);
      const [selectedEntry, setSelectedEntry] = useState(null);

      const handleFileChange = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setLoadError("");

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const text = event.target.result;
            const json = JSON.parse(text);
            if (!Array.isArray(json)) {
              throw new Error("JSON root must be an array of entries");
            }
            setRawData(json);
          } catch (err) {
            console.error(err);
            setLoadError(err.message || "Failed to parse JSON file");
            setRawData([]);
          }
        };
        reader.onerror = () => {
          setLoadError("Could not read file");
        };
        reader.readAsText(file);
      };

      const cleanedData = useMemo(
        () => (Array.isArray(rawData) ? rawData : []),
        [rawData]
      );

      const allAreas = useMemo(() => {
        const set = new Set();
        cleanedData.forEach((d) => {
          if (d.area) set.add(d.area);
        });
        return Array.from(set).sort();
      }, [cleanedData]);

      const filtered = useMemo(() => {
        return cleanedData.filter((entry) => {
          if (selectedArea !== "All" && entry.area !== selectedArea) {
            return false;
          }
          const hour = parseHour(entry.timestamp);
          if (hour != null) {
            if (hour < hourRange[0] || hour > hourRange[1]) return false;
          }
          if (search.trim()) {
            const q = search.toLowerCase();
            const haystack = (
              (entry.notes || "") +
              " " +
              (entry.area || "") +
              " " +
              (entry.timestamp || "")
            ).toLowerCase();
            if (!haystack.includes(q)) return false;
          }
          return true;
        });
      }, [cleanedData, selectedArea, hourRange, search]);

      const stats = useMemo(() => {
        const total = cleanedData.length;
        const uniqueAreas = new Set(cleanedData.map((d) => d.area || "Unknown")).size;
        const withImages = cleanedData.filter((d) => !!d.image).length;
        const times = cleanedData
          .map((d) => parseHour(d.timestamp))
          .filter((h) => h != null)
          .sort((a, b) => a - b);

        return {
          total,
          uniqueAreas,
          withImages,
          firstHour: times.length ? times[0] : null,
          lastHour: times.length ? times[times.length - 1] : null,
        };
      }, [cleanedData]);

      return (
        <div className="min-h-screen flex bg-slate-950">
          {/* Sidebar */}
          <aside className="w-72 border-r border-slate-900 bg-slate-950/95 p-4 flex flex-col gap-4">
            <div className="mb-2">
              <h1 className="text-base font-semibold text-slate-50">
                Trading Journal Analyzer
              </h1>
              <p className="text-[11px] text-slate-500 mt-1">
                Import your JSON journal and analyze patterns.
              </p>
            </div>

            {/* Import JSON */}
            <div className="flex flex-col gap-1">
              <label className="text-[11px] font-medium text-slate-400">
                Import JSON file
              </label>
              <input
                type="file"
                accept=".json,application/json"
                onChange={handleFileChange}
                className="text-[11px] file:text-[11px] file:px-2 file:py-1 file:rounded-lg file:bg-slate-800 file:border-0 file:text-slate-100 file:cursor-pointer text-slate-400"
              />
              <p className="text-[10px] text-slate-500">
                Expected: array of entries with fields like
                <span className="font-mono"> timestamp, area, notes, image</span>.
              </p>
              {loadError && (
                <p className="text-[10px] text-rose-400">
                  {loadError}
                </p>
              )}
              {cleanedData.length > 0 && !loadError && (
                <p className="text-[10px] text-emerald-400">
                  Loaded {cleanedData.length} entries.
                </p>
              )}
            </div>

            {/* Filters */}
            <div className="space-y-3 mt-2">
              {/* Search */}
              <div className="flex flex-col gap-1">
                <label className="text-[11px] font-medium text-slate-400">
                  Search notes / area / time
                </label>
                <input
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  placeholder="e.g. 21EMA, pdl, reversal..."
                  className="text-xs px-3 py-2 rounded-xl bg-slate-900 border border-slate-800 focus:outline-none focus:ring-1 focus:ring-emerald-400/60 focus:border-emerald-500/60 placeholder:text-slate-600"
                />
              </div>

              {/* Area filter */}
              <div className="flex flex-col gap-1">
                <label className="text-[11px] font-medium text-slate-400">
                  Area / Setup
                </label>
                <select
                  value={selectedArea}
                  onChange={(e) => setSelectedArea(e.target.value)}
                  className="text-xs px-3 py-2 rounded-xl bg-slate-900 border border-slate-800 focus:outline-none focus:ring-1 focus:ring-emerald-400/60 focus:border-emerald-500/60"
                >
                  <option value="All">All areas ({allAreas.length})</option>
                  {allAreas.map((area) => (
                    <option key={area} value={area}>
                      {area}
                    </option>
                  ))}
                </select>
              </div>

              {/* Hour range filter */}
              <div className="flex flex-col gap-2">
                <label className="text-[11px] font-medium text-slate-400">
                  Time window (hour)
                </label>
                <div className="flex items-center gap-2 text-[11px] text-slate-400">
                  <span>{hourRange[0].toString().padStart(2, "0")}:00</span>
                  <input
                    type="range"
                    min="0"
                    max="23"
                    value={hourRange[0]}
                    onChange={(e) =>
                      setHourRange(([_, max]) => [
                        Math.min(parseInt(e.target.value, 10), max),
                        max,
                      ])
                    }
                    className="flex-1"
                  />
                </div>
                <div className="flex items-center gap-2 text-[11px] text-slate-400">
                  <span>{hourRange[1].toString().padStart(2, "0")}:59</span>
                  <input
                    type="range"
                    min="0"
                    max="23"
                    value={hourRange[1]}
                    onChange={(e) =>
                      setHourRange(([min, _]) => [
                        min,
                        Math.max(parseInt(e.target.value, 10), min),
                      ])
                    }
                    className="flex-1"
                  />
                </div>
              </div>
            </div>

            <div className="mt-auto pt-4 border-t border-slate-900 text-[10px] text-slate-600">
              <p>
                You can export updated JSON from your app and drop it here anytime.
              </p>
            </div>
          </aside>

          {/* Main content */}
          <main className="flex-1 p-4 md:p-6 flex flex-col gap-4">
            {/* Stats row */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <StatCard
                label="Total entries"
                value={stats.total}
                sub={`Filtered: ${filtered.length}`}
              />
              <StatCard
                label="Unique areas"
                value={stats.uniqueAreas}
                sub="Different setups/contexts"
              />
              <StatCard
                label="Entries with charts"
                value={stats.withImages}
                sub={`~${stats.total ? Math.round((stats.withImages / stats.total) * 100) : 0}%`}
              />
              <StatCard
                label="Time span"
                value={
                  stats.firstHour != null
                    ? `${stats.firstHour
                        .toString()
                        .padStart(2, "0")}–${stats.lastHour
                        .toString()
                        .padStart(2, "0")}h`
                    : "N/A"
                }
                sub="Based on timestamp field"
              />
            </div>

            {/* Middle row: charts */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <AreaDistribution data={filtered} />
              <HourHeatmap data={filtered} />
            </div>

            {/* Table */}
            <div className="flex-1 min-h-[300px]">
              <JournalTable data={filtered} onOpenImage={setSelectedEntry} />
            </div>
          </main>

          <ImageModal entry={selectedEntry} onClose={() => setSelectedEntry(null)} />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
